<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pedido de Delivery</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #002a7b; /* Azul #002a7b */
      margin: 20px;
      background-image: radial-gradient(circle at center bottom, rgba(255,255,255,0.3) 20%, rgba(255,255,255,0) 100%);
      background-size: cover;
    }
    h1 {
      text-align: center;
      color: white;
    }
    form {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      background-color: #000;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      color: white;
    }
    label {
      font-weight: bold;
      margin-top: 10px;
      display: block;
    }
    input, select, textarea {
      width: calc(100% - 20px);
      padding: 10px;
      margin-top: 5px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #333;
      color: white;
    }
    .item-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 10px;
      border: 1px solid #444;
      margin-bottom: 10px;
    }
    .item-row select, .item-row input {
      width: 32%;
      background-color: #000;
    }
    .add-item {
      text-align: center;
      margin-bottom: 15px;
    }
    .taxa-fixa {
      background-color: #333;
      border: none;
      color: white;
      font-weight: bold;
    }
    button {
      padding: 8px 15px;
      background-color: #002a7b;
      color: white;
      font-size: 14px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button:hover {
      background-color: #001e56;
      transition: background-color 0.3s ease;
    }
    textarea {
      background-color: #000;
    }
    .item-row button {
      width: 32%;
      padding: 8px 15px;
      font-size: 14px;
    }
    .add-item button,
    form button[type="submit"] {
      width: 100%;
      padding: 12px 20px;
      font-size: 16px;
    }
    .status-container {
      background-color: #000;
      color: #fff;
      padding: 25px 50px;
      border-radius: 8px;
      text-align: center;
      margin: 30px auto;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      max-width: 600px;
    }
    .status-container.fechado {
      background-color: #000;
      color: #fff;
      font-size: 24px;
    }
    .status-container.aberto {
      background-color: #000;
      color: #fff;
      font-size: 24px;
    }
    #opcao-entrega {
      text-align: center;
      margin-bottom: 15px;
    }
    #opcao-entrega button {
      width: 45%;
      margin: 0 2%;
      padding: 10px;
      font-size: 16px;
    }
    #opcao-entrega button.selected {
      background-color: #001e56;
    }
    /* Estilo para a área de adicionais dentro do item */
    .extras-container {
      width: 100%;
      margin-top: 10px;
    }
    .extras-container p {
      margin: 0 0 5px 0;
      font-weight: bold;
    }
    /* Estilo para a descrição do produto (exibida na interface, mas não enviada no WhatsApp) */
    .descricao-produto {
      width: 100%;
      margin-bottom: 10px;
      color: #ccc;
      font-size: 0.9em;
      font-style: italic;
    }
  </style>
  <script>
    // Opção de entrega ou retirada (padrão: entrega)
    let opcaoEntrega = "entrega";

    // Objeto para armazenar os produtos carregados da planilha
    const produtos = {};

    // Função para carregar os produtos (incluindo descrição e adicionais) da planilha do Google Sheets (CSV)
    async function carregarProdutosDaPlanilha() {
      const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSGudIAhY04w2oPsRfM4bckCWCqPn7triE4M2f4BsdLcSqYeVwJJMv8IEwgCh33l29fH5JVuoa9pllZ/pub?output=csv";
      try {
        const resposta = await fetch(url);
        const csvText = await resposta.text();
        const linhas = csvText.split("\n").map(linha => linha.trim()).filter(linha => linha);
        linhas.shift(); // Remove o cabeçalho

        // Limpa o objeto de produtos (caso já tenha dados)
        for (const key in produtos) {
          delete produtos[key];
        }

        linhas.forEach(linha => {
          // Divide a linha em colunas (utilize um parser CSV se necessário)
          const colunas = linha.split(",").map(coluna => coluna.trim());

          /* Estrutura da planilha (9 colunas):
             0: Produto
             1: Preço
             2: Descrição
             3: Adicional 1
             4: Preço Adicional 1
             5: Adicional 2
             6: Preço Adicional 2
             7: Adicional 3
             8: Preço Adicional 3
          */
          const nome = colunas[0];
          const preco = parseFloat(colunas[1].replace(",", ".")) || 0;
          const descricao = colunas[2];

          // Cria um array para os adicionais deste produto
          const adicionais = [];
          if (colunas[3] && colunas[4]) {
            adicionais.push({
              nome: colunas[3],
              preco: parseFloat(colunas[4].replace(",", ".")) || 0
            });
          }
          if (colunas[5] && colunas[6]) {
            adicionais.push({
              nome: colunas[5],
              preco: parseFloat(colunas[6].replace(",", ".")) || 0
            });
          }
          if (colunas[7] && colunas[8]) {
            adicionais.push({
              nome: colunas[7],
              preco: parseFloat(colunas[8].replace(",", ".")) || 0
            });
          }

          // Armazena os dados do produto, incluindo descrição e adicionais
          produtos[nome] = { preco, descricao, adicionais };
        });
        console.log("Produtos carregados:", produtos);
        atualizarSelectProdutos();
      } catch (error) {
        console.error("Erro ao carregar os produtos:", error);
      }
    }

    // Atualiza os selects já existentes com os produtos carregados
    function atualizarSelectProdutos() {
      const selects = document.querySelectorAll("#itens-container .item-row select:first-child");
      selects.forEach(select => {
        const currentValue = select.value;
        let optionsHTML = `<option value="">Selecione o produto</option>`;
        optionsHTML += Object.keys(produtos)
          .map(produto => `<option value="${produto}">${produto} - R$ ${produtos[produto].preco.toFixed(2)}</option>`)
          .join('');
        select.innerHTML = optionsHTML;
        if (currentValue && optionsHTML.indexOf(`value="${currentValue}"`) !== -1) {
          select.value = currentValue;
        }
      });
    }

    // Seleciona a opção de entrega ou retirada
    function selecionarOpcao(opcao) {
      opcaoEntrega = opcao;
      document.getElementById("btn-entrega").classList.remove("selected");
      document.getElementById("btn-retirada").classList.remove("selected");
      if (opcao === "entrega") {
        document.getElementById("btn-entrega").classList.add("selected");
      } else {
        document.getElementById("btn-retirada").classList.add("selected");
      }
      calcularTotal();
    }

    // Adiciona um novo item no pedido
    function adicionarItem() {
      const itensContainer = document.getElementById("itens-container");
      const novoItem = document.createElement("div");
      novoItem.className = "item-row";
      novoItem.innerHTML = `
        <select onchange="produtoSelecionado(this)">
          <option value="">Selecione o produto</option>
          ${Object.keys(produtos)
            .map(produto => `<option value="${produto}">${produto} - R$ ${produtos[produto].preco.toFixed(2)}</option>`)
            .join('')}
        </select>
        <select onchange="atualizarPrecoTotal(this)">
          ${[...Array(10)].map((_, i) => `<option value="${i + 1}">Quantidade: ${i + 1}</option>`).join('')}
        </select>
        <input type="number" placeholder="Preço Total (R$)" step="0.01" readonly>
        <button onclick="removerItem(this)">Remover</button>
        <!-- Container para a descrição do produto (exibida na interface, mas NÃO incluída no WhatsApp) -->
        <div class="descricao-produto"></div>
        <div class="extras-container"></div>
      `;
      itensContainer.appendChild(novoItem);
      atualizarSelectProdutos();
    }

    // Função chamada ao selecionar um produto (para renderizar a descrição e os adicionais, se houver)
    function produtoSelecionado(selectElement) {
      const itemRow = selectElement.closest('.item-row');
      const produto = selectElement.value;
      renderDescricaoForRow(itemRow, produto);
      renderExtrasForRow(itemRow, produto);
      atualizarPrecoTotal(selectElement);
    }

    // Renderiza a descrição do produto na área designada (apenas exibida na interface)
    function renderDescricaoForRow(itemRow, produto) {
      const descricaoContainer = itemRow.querySelector('.descricao-produto');
      if (produto && produtos[produto] && produtos[produto].descricao) {
        descricaoContainer.innerText = produtos[produto].descricao;
      } else {
        descricaoContainer.innerText = "";
      }
    }

    // Renderiza os adicionais para o item, caso o produto possua adicionais
    function renderExtrasForRow(itemRow, produto) {
      const extrasContainer = itemRow.querySelector('.extras-container');
      if (produto && produtos[produto] && produtos[produto].adicionais.length > 0) {
        let html = `<p>Adicionais:</p>`;
        produtos[produto].adicionais.forEach(extra => {
          html += `<label style="margin-right:10px;">
                    <input type="checkbox" data-extra-preco="${extra.preco}" data-extra-nome="${extra.nome}" onchange="atualizarPrecoTotal(this)">
                    ${extra.nome} (R$ ${extra.preco.toFixed(2)})
                   </label>`;
        });
        extrasContainer.innerHTML = html;
      } else {
        extrasContainer.innerHTML = "";
      }
    }

    // Atualiza o preço total do item.
    // O cálculo agora será: (preço base * quantidade) + soma dos adicionais (apenas uma vez, não multiplicado pela quantidade)
    function atualizarPrecoTotal(element) {
      const itemRow = element.closest('.item-row');
      const produtoSelect = itemRow.querySelector('select:first-child');
      const quantidadeSelect = itemRow.querySelector('select:nth-of-type(2)');
      const produto = produtoSelect ? produtoSelect.value : "";
      // Se quantidade não for válida, usamos 1 como padrão
      const quantidade = quantidadeSelect ? (parseInt(quantidadeSelect.value) || 1) : 1;
      if (produto) {
        let basePrice = Number(produtos[produto].preco) || 0;
        let extrasSum = 0;
        const checkboxes = itemRow.querySelectorAll('.extras-container input[type="checkbox"]');
        checkboxes.forEach(cb => {
          if (cb.checked) {
            extrasSum += Number(cb.getAttribute('data-extra-preco')) || 0;
          }
        });
        // O total do item será: (preço base * quantidade) + adicionais (soma única)
        const totalPrice = (basePrice * quantidade) + extrasSum;
        itemRow.querySelector('input[readonly]').value = totalPrice.toFixed(2);
        calcularTotal();
      } else {
        itemRow.querySelector('input[readonly]').value = "";
        calcularTotal();
      }
    }

    // Calcula o total do pedido somando os totais de cada item e a taxa de entrega (se aplicável)
    function calcularTotal() {
      const itensContainer = document.getElementById("itens-container").children;
      let total = 0;
      for (let i = 0; i < itensContainer.length; i++) {
        const itemRow = itensContainer[i];
        const precoTotal = parseFloat(itemRow.querySelector('input[readonly]').value) || 0;
        total += precoTotal;
      }
      const taxaEntrega = opcaoEntrega === "retirada" ? 0 : parseFloat(document.getElementById("taxa").value) || 0;
      const totalPedido = total + taxaEntrega;
      document.getElementById("total").value = totalPedido.toFixed(2);
    }

    // Envia o pedido via WhatsApp com a mensagem formatada (a descrição NÃO é incluída)
    function enviarPedido() {
      const nome = document.getElementById("nome").value;
      const endereco = document.getElementById("endereco").value;
      const complemento = document.getElementById("complemento") ? document.getElementById("complemento").value : "";
      const pontoReferencia = document.getElementById("ponto-referencia") ? document.getElementById("ponto-referencia").value : "";
      const taxa = opcaoEntrega === "retirada" ? "0.00" : document.getElementById("taxa").value;
      const pagamento = document.getElementById("pagamento").value;
      const total = document.getElementById("total").value;
      const observacoes = document.getElementById("observacoes").value;
      const itensContainer = document.getElementById("itens-container").children;
      let itens = "";
      let temProdutoVazio = false;

      for (let i = 0; i < itensContainer.length; i++) {
        const itemRow = itensContainer[i];
        const produtoSelecionado = itemRow.querySelector('select:first-child').value;
        if (produtoSelecionado === "") {
          temProdutoVazio = true;
          break;
        }
        const quantidade = itemRow.querySelector('select:nth-of-type(2)').value;
        const precoTotal = itemRow.querySelector('input[readonly]').value;
        // Monta a linha principal do item (a descrição NÃO é incluída)
        let itemText = `${produtoSelecionado} x${quantidade} - R$ ${precoTotal}\n`;
        // Adiciona os adicionais selecionados
        const extrasContainer = itemRow.querySelector('.extras-container');
        const checkboxes = extrasContainer.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(cb => {
          if (cb.checked) {
            const nomeExtra = cb.getAttribute('data-extra-nome');
            const precoExtra = Number(cb.getAttribute('data-extra-preco')).toFixed(2);
            itemText += `   + ${nomeExtra} (R$ ${precoExtra})\n`;
          }
        });
        itens += itemText;
      }

      if (temProdutoVazio) {
        alert("Por favor, selecione um produto ou remova os itens vazios do seu pedido.");
        return;
      }

      let mensagem = `*PEDIDO*\n\n📋 *Dados do Cliente:*\n- Nome: ${nome}\n- Endereço: ${endereco}\n`;
      if (complemento) mensagem += `- Complemento: ${complemento}\n`;
      if (pontoReferencia) {
        mensagem += `- Ponto de Referência: ${pontoReferencia}\n`;
      } else {
        alert("Por favor, preencha o Ponto de Referência para facilitar a localização.");
        return;
      }
      mensagem += `\n📦 *Itens do Pedido:*\n${itens}\n💵 *Forma de Pagamento:* ${pagamento}\n`;
      if (pagamento === 'PIX') {
        mensagem += `PIX - Chave: renimarfilho000@gmail.com\n`;
      } else if (pagamento === 'Cartão de Crédito' || pagamento === 'Cartão de Débito') {
        mensagem += `Cartão - Link para Pagamento: link.mercadopago.com.br/flowmize\n`;
      } else if (pagamento === 'Dinheiro') {
        mensagem += `Dinheiro\n`;
      }
      mensagem += `🚚 *Taxa de Entrega:* R$ ${taxa}\n🔴 *Total do Pedido:* R$ ${total}\n\n*Modo:* ${opcaoEntrega === "entrega" ? "Entrega" : "Retirada"}\n\n*Observações:* ${observacoes}`;

      const telefone = "98981729088";
      if (parseFloat(total) > 0) {
        const url = `https://wa.me/55${telefone}?text=${encodeURIComponent(mensagem)}`;
        window.open(url, "_blank");
      } else {
        alert("Por favor, adicione pelo menos um item ao seu pedido.");
      }
    }

    // Remove um item do pedido
    function removerItem(button) {
      const itemRow = button.closest('.item-row');
      itemRow.remove();
      calcularTotal();
    }

    // Atualiza a mensagem de status (aberto/fechado)
    function atualizarStatus() {
      const statusContainer = document.getElementById("status-container");
      const now = new Date();
      const saoPauloTimeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
      const saoPauloTime = new Date(now.toLocaleString('pt-BR', { timeZone: saoPauloTimeZone }));
      const startTime = new Date(saoPauloTime.getFullYear(), saoPauloTime.getMonth(), saoPauloTime.getDate(), 18, 0, 0);
      const endTime = new Date(saoPauloTime.getFullYear(), saoPauloTime.getMonth(), saoPauloTime.getDate(), 22, 0, 0);
      if (saoPauloTime >= startTime && saoPauloTime <= endTime) {
        statusContainer.innerHTML = "Estamos Abertos 🥳";
        statusContainer.classList.add("aberto");
        statusContainer.classList.remove("fechado");
      } else {
        statusContainer.innerHTML = "Estamos Fechados 😕";
        statusContainer.classList.add("fechado");
        statusContainer.classList.remove("aberto");
      }
    }

    setInterval(atualizarStatus, 1000);

    window.addEventListener('DOMContentLoaded', function() {
      carregarProdutosDaPlanilha();
      atualizarStatus();
    });
  </script>
</head>
<body>
  <div class="status-container" id="status-container">
    <!-- Mensagem de status -->
  </div>
  <form onsubmit="event.preventDefault(); enviarPedido();">
    <h1>PEDIDO</h1>
    <label for="nome">Nome do Cliente:</label>
    <input type="text" id="nome" name="nome" placeholder="Digite seu nome" required>
    <label for="endereco">Endereço de Entrega:</label>
    <input type="text" id="endereco" name="endereco" placeholder="Cidade, Bairro, Rua, Número" required>
    <label for="complemento">Complemento (opcional):</label>
    <input type="text" id="complemento" name="complemento" placeholder="Ex: Apto. 101">
    <label for="ponto-referencia">Ponto de Referência:</label>
    <input type="text" id="ponto-referencia" name="ponto-referencia" placeholder="Ex: Em frente a padaria, ao lado do banco" required>
    <label>Itens do Pedido:</label>
    <div id="itens-container" class="itens-container">
      <!-- Itens adicionados dinamicamente -->
    </div>
    <div class="add-item">
      <button type="button" onclick="adicionarItem()">Adicionar Item</button>
    </div>
    <label for="taxa">Taxa de Entrega (R$):</label>
    <input type="number" id="taxa" name="taxa" value="4.00" class="taxa-fixa" readonly>
    <label for="pagamento">Forma de Pagamento:</label>
    <select id="pagamento" name="pagamento" required>
      <option value="Dinheiro">Dinheiro</option>
      <option value="Cartão de Crédito">Cartão de Crédito</option>
      <option value="Cartão de Débito">Cartão de Débito</option>
      <option value="PIX">PIX</option>
    </select>
    <label for="observacoes">Observações:</label>
    <textarea id="observacoes" name="observacoes" placeholder="Digite suas observações" rows="4"></textarea>
    <label>Opção:</label>
    <div id="opcao-entrega">
      <button type="button" id="btn-entrega" onclick="selecionarOpcao('entrega')" class="selected">Entrega</button>
      <button type="button" id="btn-retirada" onclick="selecionarOpcao('retirada')">Retirada</button>
    </div>
    <label for="total">Total:</label>
    <input type="number" id="total" name="total" placeholder="Total do Pedido" readonly>
    <button type="submit">Enviar Pedido</button>
  </form>
  <script>
    window.addEventListener('DOMContentLoaded', function() {
      carregarProdutosDaPlanilha();
      atualizarStatus();
    });
  </script>
</body>
</html>
